{
  "hash": "b0bad614de312fc398f03e626802dc50",
  "result": {
    "engine": "knitr",
    "markdown": "# 箱线图\n\n## 箱线图陷阱\n\n箱线图又叫盒须图，展示数据的中位数(median)、上下四分位数(Quartiles)、四分位距(IQR)、须线(Whiskers)和异常值(outlier)。\n\n这是说明箱线图构成的示意图：\n![](./image/boxplot_explanation_1.png)\n![](./image/boxplot_explanation_2.png)\n\n\n但是，这种信息的总结也有个大问题——**无法显示数据的分布情况**。例如：正态分布可能看起来与双峰分布完全相同。因此，考虑用小提琴图或脊线图。\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(hrbrthemes) # hrbrthemes 提供了更适合排版的主题\nlibrary(viridis) # viridis 提供了好看的色盲友好型颜色\n\n# 创建数据集\ndata1 <- data.frame(\n  name = c(\n    rep(\"A\", 500),\n    rep(\"B\", 250),\n    rep(\"B\", 250),\n    rep(\"C\", 20),\n    rep('D', 100)\n  ),\n  value = c(\n    rnorm(500, 10, 5),\n    rnorm(250, 13, 1),\n    rnorm(250, 18, 1),\n    rnorm(20, 25, 4),\n    rnorm(100, 12, 1)\n  )\n)\n\ndata1 |> \n  ggplot(aes(x = name, y = value, fill = name)) +\n  geom_boxplot() +\n  scale_fill_viridis(discrete = TRUE) + # 好看的色盲友好型颜色,离散变量\n  theme_ipsum() + # 更适合排版的主题\n  theme(legend.position = \"none\") + \n  labs(x = \"\") + \n  ggtitle(\"A somewhat misleading boxplot\") \n```\n\n::: {.cell-output-display}\n![](箱线图_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n## 改进\n\n### 添加抖动(Jitter)\n\n适合数据量不太大的情况\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata1 |> \n  ggplot( aes(x=name, y=value, fill=name)) +\n    geom_boxplot() +\n    scale_fill_viridis(discrete = TRUE) +  # 好看的色盲友好型颜色,离散变量\n    geom_jitter(color=\"grey\", size=0.5, alpha=0.5) +\n    theme_ipsum() + # 更适合排版的主题\n    theme(legend.position=\"none\") +\n    labs(x = \"\") + \n    ggtitle(\"A boxplot with jitter\")\n```\n\n::: {.cell-output-display}\n![添加抖动(jitter)的箱线图](箱线图_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n发现:\n\n- 组 C 样本量小。在得出组 C 的值高于其他组的结论之前，要考虑样本量.\n\n- 组 B 呈现出双峰分布(y = 18 和 y = 13),但是箱线图中看起来和组 A 并无区别.\n\n### 小提琴图(Violin)\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 显示样本量\nsample_size = data1 |> group_by(name) |> summarize(num = n())\n\ndata1  |>\n  left_join(sample_size) |>\n  mutate(myaxis = paste0(name, \"\\n\", \"n=\", num)) |>\n  ggplot(aes(x = myaxis, y = value, fill = name)) +\n  geom_violin(width = 1.4) +\n  geom_boxplot(width = 0.1, color = \"grey\", alpha = 0.2) +\n  scale_fill_viridis(discrete = TRUE) +\n  theme_ipsum() +\n  theme(legend.position = \"none\") +\n  labs(x = \"\") + \n  ggtitle(\"A violin plot\")\n```\n\n::: {.cell-output-display}\n![](箱线图_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n### 云雨图(Raincloud)\n\n看了就知道,云(半小提琴)+雨(散点)的组合。\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggdist) # ggdist 提供了半小提琴图和云雨图\nlibrary(hrbrthemes) # hrbrthemes 提供了更适合排版的主题\nlibrary(viridis) # viridis 提供了好看的色盲友好型颜色\n\ndata1 |>\n    ggplot(aes(x = factor(name), y = value, fill = factor(name))) +\n\n    # 添加半小提琴图（显示分布）\n    stat_halfeye(\n        adjust = 0.5,\n        justification = -0.1,\n        .width = 0,\n        point_colour = NA\n    ) +\n\n    # 添加散点（显示原始数据点）\n    stat_dots(\n        side = \"left\",\n        justification = 1.1,\n        binwidth = 0.25\n    ) +\n\n    # 设置色盲友好型配色\n    scale_fill_viridis(discrete = TRUE) +\n    theme_ipsum() +\n    theme(legend.position = \"none\") + \n    labs(x = \"\") +\n    ggtitle(\"A raincloud plot example\") \n```\n\n::: {.cell-output-display}\n![](箱线图_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n把**头顺时针旋转90度**(或交换R代码X轴和Y轴)，就更像云雨了\n\n甚至还可以再加上箱线图\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggdist) # ggdist 提供了半小提琴图和云雨图\nlibrary(hrbrthemes) # hrbrthemes 提供了更适合排版的主题\nlibrary(viridis) # viridis 提供了好看的色盲友好型颜色\n\ndata1 |>\n    ggplot(aes(x = factor(name), y = value, fill = factor(name))) +\n\n    # 添加半小提琴图（显示分布）\n    stat_halfeye(\n        adjust = 0.5,\n        justification = -0.2,\n        .width = 0,\n        point_colour = NA\n    ) +\n\n    # 添加箱线图\n    geom_boxplot(\n        width = 0.12,\n        outlier.color = NA,\n        alpha = 0.5\n    ) +\n\n    # 添加散点（显示原始数据点）\n    stat_dots(\n        side = \"left\",\n        justification = 1.1,\n        binwidth = 0.25\n    ) +\n\n    # 设置色盲友好型配色\n    scale_fill_viridis(discrete = TRUE) +\n    theme_ipsum() +\n    theme(legend.position = \"none\") + \n    labs(x = \"\") +\n    ggtitle(\"A raincloud plot example\") \n```\n\n::: {.cell-output-display}\n![](箱线图_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n## ggplot2\n主要是geom_boxplot()函数.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(mpg, aes(x = class, y = hwy)) + \n    geom_boxplot()\n```\n\n::: {.cell-output-display}\n![最基础的箱线图](箱线图_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(mpg, aes(x=class, y=hwy)) + \n  geom_boxplot(\n    color=\"blue\",         # 箱线图边框颜色为蓝色\n    fill=\"blue\",          # 箱体填充颜色为蓝色\n    alpha=0.2,            # 箱体透明度为0.2，便于观察重叠部分\n    \n    notch=TRUE,           # 显示缺口，用于比较中位数是否有显著差异\n    notchwidth = 0.8,     # 缺口的宽度\n    \n    outlier.colour=\"red\", # 异常值点的边框颜色为红色\n    outlier.fill=\"red\",   # 异常值点的填充颜色为红色\n    outlier.size=1        # 异常值点的大小为3\n  )\n```\n\n::: {.cell-output-display}\n![有细腰的箱线图](箱线图_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmpg |>\n  # fct_reorder() 函数排序\n  ggplot( aes(x=fct_reorder(class, hwy, .fun='median'), y=hwy)) + \n    geom_boxplot()\n```\n\n::: {.cell-output-display}\n![用均值排序箱线图](箱线图_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(patchwork)\n \np1 <- ggplot(mpg, aes(x=class, y=hwy)) + \n    geom_boxplot(color=\"red\", fill=\"orange\", alpha=0.2)\n \np2 <- ggplot(mpg, aes(x=class, y=hwy, fill=class)) + \n    geom_boxplot(alpha=0.3) +\n    theme(legend.position=\"none\")\n\np3 <- ggplot(mpg, aes(x=class, y=hwy, fill=class)) + \n    geom_boxplot(alpha=0.3) +\n    theme(legend.position=\"none\") +\n    scale_fill_brewer(palette=\"BuPu\") # 调色板\n \np4 <- ggplot(mpg, aes(x=class, y=hwy, fill=class)) + \n    geom_boxplot(alpha=0.3) +\n    theme(legend.position=\"none\") +\n    scale_fill_brewer(palette=\"Dark2\") # 调色板\n\np1 + p2 + p3 + p4\n```\n\n::: {.cell-output-display}\n![改变颜色](箱线图_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(hrbrthemes)\n\nmpg |> \n  # 添加一列 'type'，用于标记是否高亮某个组\n  mutate(type = ifelse(class == \"subcompact\", \"Highlighted\", \"Normal\")) |>\n  \n  ggplot(aes(x = class, y = hwy, fill = type, alpha = type)) + \n    geom_boxplot() + \n    scale_fill_manual(values = c(\"#69b3a2\", \"grey\")) + # 手动设置填充色，高亮组为绿色，其余为灰色\n    scale_alpha_manual(values = c(1, 0.1)) + # 手动设置透明度，高亮组为不透明，其余为半透明\n    theme_ipsum() + # 使用 hrbrthemes 包的排版主题\n    theme(legend.position = \"none\") + # 不显示图例\n    xlab(\"\") # 去除 x 轴标签\n```\n\n::: {.cell-output-display}\n![高亮某个组](箱线图_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(patchwork)\n#| fig-cap: 分组箱线图与分面箱线图\n# 构造数据\nvariety = rep(LETTERS[1:7], each = 40) # 7种品种，每种40个观测\ntreatment = rep(c(\"high\", \"low\"), each = 20) # 处理分为high和low，每组20个观测\nnote = seq(1:280) + sample(1:150, 280, replace = TRUE) # 生成note变量，添加一定随机性\ndata2 = data.frame(variety, treatment, note) # 组合成数据框\n\n# 分组箱线图\nggplot(data2, aes(x = variety, y = note, fill = treatment)) + \n  geom_boxplot()\n```\n\n::: {.cell-output-display}\n![](箱线图_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# 少分面箱线图\nggplot(data2, aes(x=variety, y=note, fill=treatment)) + \n    geom_boxplot() +\n    facet_wrap(~treatment)\n```\n\n::: {.cell-output-display}\n![](箱线图_files/figure-html/unnamed-chunk-11-2.png){width=672}\n:::\n\n```{.r .cell-code}\n# 多分面箱线图\nggplot(data2, aes(x=variety, y=note, fill=treatment)) + \n    geom_boxplot() +\n    facet_wrap(~variety, scale=\"free\") # 自由y轴\n```\n\n::: {.cell-output-display}\n![](箱线图_files/figure-html/unnamed-chunk-11-3.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# 转换为因子类型\nmpg$drv <- as.factor(mpg$drv) \n# 创建x轴标签，包含每个drv水平的名称及其对应的样本量\nn_xlab <- str_glue(\"{levels(mpg$drv)}\\n(N={table(mpg$drv)})\")\n\nggplot(mpg, aes(x = drv, y = hwy, fill = drv)) + \n    geom_boxplot(varwidth = TRUE, alpha = 0.2) + # varwidth = TRUE 不等宽\n    scale_x_discrete(labels = n_xlab) + \n    theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![不等宽箱线图(宽带是样本量)](箱线图_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndiamonds |>\n  mutate(bin = cut_width(carat, width = 0.5, boundary = 0)) |>\n  ggplot(aes(x = bin, y = price)) +\n  geom_boxplot() \n```\n\n::: {.cell-output-display}\n![连续变量箱线图](箱线图_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(mpg, aes(x=drv, y=hwy, fill=drv)) +\n    geom_boxplot(alpha=0.7) +\n    stat_summary(fun.y=mean, geom=\"point\", shape=1, size=2, color = 'red') +\n    theme(legend.position=\"none\") \n```\n\n::: {.cell-output-display}\n![添加均值点](箱线图_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# data1 是之前创建的数据集\ndata1 |> \n  ggplot( aes(x=name, y=value, fill=name)) +\n    geom_boxplot() +\n    scale_fill_viridis(discrete = TRUE) +  # 好看的色盲友好型颜色,离散变量\n    geom_jitter(color=\"grey\", size=0.5, alpha=0.5) +\n    theme_ipsum() + # 更适合排版的主题\n    theme(legend.position=\"none\") +\n    labs(x = \"\") + \n    ggtitle(\"A boxplot with jitter\")\n```\n\n::: {.cell-output-display}\n![带抖动的箱线图](箱线图_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n可以library(ggExtra)来实现更复杂（花哨）的图形，在ggplot2散点图的基础上再叠加箱线图、密度曲线等。\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggExtra)\n# 创建ggplot散点图\np <- ggplot(mtcars, aes(x = wt, y = mpg, color = cyl, size = cyl)) +\n  geom_point() +\n  theme(legend.position = \"none\")\n\nggMarginal(p, type = \"histogram\")\n```\n\n::: {.cell-output-display}\n![ggMarginal散点图叠加直方图](箱线图_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggMarginal(p, type = \"density\")\n```\n\n::: {.cell-output-display}\n![ggMarginal散点图叠加密度图](箱线图_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggMarginal(p, type = \"boxplot\")\n```\n\n::: {.cell-output-display}\n![ggMarginal散点图叠加箱线图](箱线图_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n还可以定制化样式：\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 设置边际直方图的尺寸大小为10\nggMarginal(p, type = \"histogram\", size = 10)\n```\n\n::: {.cell-output-display}\n![ggMarginal定制化样式-尺寸大小](箱线图_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# 设置边际直方图的填充颜色为slateblue，x轴直方图分箱数为10\nggMarginal(p, type = \"histogram\", fill = \"slateblue\", xparams = list(bins = 10))\n```\n\n::: {.cell-output-display}\n![ggMarginal定制化样式-颜色和分箱](箱线图_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# 只在x轴添加边际图，边际图颜色为紫色，尺寸为4\nggMarginal(p, margins = 'x', color = \"purple\", size = 4)\n```\n\n::: {.cell-output-display}\n![ggMarginal定制化样式-颜色和尺寸](箱线图_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n## Base R\n主要是通过`boxplot()`函数.\n\n但是 base R 多看一秒都是浪费时间,直接ggplot2吧.\n\n如果实在想学,可以看 [r-graph-gallery](https://r-graph-gallery.com/boxplot.html) 的文档。\n\n## Pearl\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npalmerpenguins::penguins |>\n  drop_na() |>\n  ggstatsplot::ggbetweenstats(x = species, y = flipper_length_mm, 1)\n```\n\n::: {.cell-output-display}\n![带有统计的小提琴箱线图](箱线图_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n在 [ggstatsplot](https://r-graph-gallery.com/web-violinplot-with-ggstatsplot.html) 可以看到进一步美化。\n\n或者\n\n在 [tidyplots](https://tidyplots.org/use-cases/) 有另一种风格的统计箱线图\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}